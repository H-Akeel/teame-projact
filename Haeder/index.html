<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>مولد التقارير المخصصة</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        text-align: center;
        direction: rtl;
        background-color: #f4f4f9;
        color: #333;
        margin: 0;
        padding: 20px;
    }
    .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1 );
        margin-bottom: 30px;
    }
    .logo-center { margin-bottom: 20px; }
    .logo-img { width: 150px; border: 2px solid #ddd; border-radius: 10px; padding: 5px; background: #fff; }
    h2 { color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 10px; margin-bottom: 20px; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .form-group { display: flex; flex-direction: column; text-align: right; }
    label { margin-bottom: 5px; font-weight: bold; color: #555; }
    input[type="text"], input[type="date"], input[type="number"] { padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
    .button-group { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
    button { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
    .generate-btn { background-color: #007bff; color: white; }
    .pdf-btn, .jpg-btn { background-color: #28a745; color: white; }
    .pdf-btn:disabled, .jpg-btn:disabled { background-color: #aaa; cursor: not-allowed; }
    
    .printable-area { border: 1px solid #ddd; padding: 20px; background: #fff; }
    .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 16px; font-weight: bold; }
    .result-table table { width: 100%; border-collapse: collapse; font-size: 14px; margin-bottom: 30px; }
    .result-table th, .result-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    .result-table th { background-color: #f2f2f2; }
    .report-footer { display: flex; justify-content: flex-end; text-align: right; }
    .signature-area { font-size: 16px; font-weight: bold; }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        text-align: center;
        direction: rtl;
        background-color: #f4f4f9;
        color: #333;
        margin: 0;
        padding: 20px;
    }
    .container {
        max-width: 900px;
        margin: 0 auto;
        background: white;
        padding: 25px;
        border-radius: 12px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1 );
        margin-bottom: 30px;
    }
    .logo-center { margin-bottom: 20px; }
    .logo-img { width: 150px; border: 2px solid #ddd; border-radius: 10px; padding: 5px; background: #fff; }
    h2 { color: #0056b3; border-bottom: 2px solid #0056b3; padding-bottom: 10px; margin-bottom: 20px; }
    .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .form-group { display: flex; flex-direction: column; text-align: right; }
    label { margin-bottom: 5px; font-weight: bold; color: #555; }
    input[type="text"], input[type="date"], input[type="number"] { padding: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
    .button-group { display: flex; justify-content: center; gap: 15px; margin-bottom: 25px; }
    button { padding: 12px 25px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; }
    .generate-btn { background-color: #007bff; color: white; }
    .pdf-btn, .jpg-btn { background-color: #28a745; color: white; }
    .pdf-btn:disabled, .jpg-btn:disabled { background-color: #aaa; cursor: not-allowed; }
    
    .printable-area { border: 1px solid #ddd; padding: 20px; background: #fff; }
    .report-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-size: 16px; font-weight: bold; }
    .result-table table { width: 100%; border-collapse: collapse; font-size: 14px; margin-bottom: 30px; }
    .result-table th, .result-table td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    .result-table th { background-color: #f2f2f2; }
    .report-footer { display: flex; justify-content: flex-end; text-align: right; }
    .signature-area { font-size: 16px; font-weight: bold; }
</style>
</head>
<body>

<!-- ======================================================================================= -->
<!--                                     القسم الأول (الجدول القديم)                               -->
<!-- ======================================================================================= -->
<div class="container">
    <div class="logo-center"><img src="https://i.imgur.com/your-logo.png" alt="الشعار" class="logo-img"></div>
    <h2>الجدول الأول: تقرير الأسماء الكامل</h2>
    <div class="form-grid">
        <div class="form-group"><label for="g1_tawn">قسم الحماية</label><input type="text" id="g1_tawn"></div>
        <div class="form-group"><label for="g1_city">المحافظة</label><input type="text" id="g1_city"></div>
        <div class="form-group"><label for="g1_table_date_input">تاريخ فوق الجدول</label><input type="date" id="g1_table_date_input"></div>
        <div class="form-group"><label for="g1_receive_date_table">تاريخ الاستلام</label><input type="date" id="g1_receive_date_table"></div>
        <div class="form-group"><label for="g1_cost_name">اسم المستلم</label><input type="text" id="g1_cost_name"></div>
        <div class="form-group"><label for="g1_cost_mother_name">اسم الأم</label><input type="text" id="g1_cost_mother_name"></div>
        <div class="form-group"><label for="g1_random_names_count">عدد الأسماء العشوائية</label><input type="number" id="g1_random_names_count" value="30" min="1" max="100"></div>
    </div>
    <div class="button-group">
        <button class="generate-btn" onclick="generateTable1( )">🔄 توليد الجدول الأول</button>
        <button id="g1_jpg-button" class="jpg-btn" onclick="downloadImage('g1_printable-area', 'g1_table_date_input', 'jpg')" disabled>📄 تحميل JPG</button>
        <button id="g1_pdf-button" class="pdf-btn" onclick="downloadImage('g1_printable-area', 'g1_table_date_input', 'pdf')" disabled>📄 تحميل PDF</button>
    </div>
    <div id="g1_printable-area" class="printable-area">
        <div class="report-header"><span id="g1_header-right"></span><span id="g1_header-center"></span><span id="g1_header-left">(7)</span></div>
        <div id="g1_result_table" class="result-table"></div>
        <div class="report-footer"><div class="signature-area"><div id="g1_footer-sequence">التسلسل 107</div></div></div>
    </div>
</div>

<!-- ======================================================================================= -->
<!--                                     القسم الثاني (الجدول الجديد)                               -->
<!-- ======================================================================================= -->
<div class="container">
    <h2>الجدول الثاني: تقرير الأسماء المختصر</h2>
    <div class="form-grid">
        <div class="form-group"><label for="g2_tawn">قسم الحماية</label><input type="text" id="g2_tawn"></div>
        <div class="form-group"><label for="g2_table_date_input">تاريخ فوق الجدول</label><input type="date" id="g2_table_date_input"></div>
        <!-- === الحقول الجديدة للإدخال اليدوي === -->
        <div class="form-group"><label for="g2_full_name">الاسم الرباعي (للإضافة)</label><input type="text" id="g2_full_name"></div>
        <div class="form-group"><label for="g2_mother_name">اسم الأم الثلاثي (للإضافة)</label><input type="text" id="g2_mother_name"></div>
    </div>
    <div class="button-group">
        <button class="generate-btn" onclick="generateTable2()">🔄 توليد الجدول الثاني</button>
        <button id="g2_jpg-button" class="jpg-btn" onclick="downloadImage('g2_printable-area', 'g2_table_date_input', 'jpg')" disabled>📄 تحميل JPG</button>
        <button id="g2_pdf-button" class="pdf-btn" onclick="downloadImage('g2_printable-area', 'g2_table_date_input', 'pdf')" disabled>📄 تحميل PDF</button>
    </div>
    <div id="g2_printable-area" class="printable-area">
        <div class="report-header"><span id="g2_header-right"></span><span id="g2_header-center"></span><span id="g2_header-left">(7)</span></div>
        <div id="g2_result_table" class="result-table"></div>
        <div class="report-footer"><div class="signature-area"><div id="g2_footer-sequence">التسلسل 107</div></div></div>
    </div>
</div>
<div class="container">
    <h2>الجدول الثالث: تقرير الأسماء مع رقم ثابت</h2>
    <div class="form-grid">
        <div class="form-group"><label for="g3_tawn">القسم</label><input type="text" id="g3_tawn"></div>
        <div class="form-group"><label for="g3_table_date_header">التاريخ فوق الجدول</label><input type="date" id="g3_table_date_header"></div>
        <div class="form-group"><label for="g3_table_date_inside">التاريخ داخل الجدول</label><input type="date" id="g3_table_date_inside"></div>
        <div class="form-group"><label for="g3_fixed_number">الرقم الثابت (4 مراتب)</label><input type="number" id="g3_fixed_number" min="1000" max="9999"></div>
        <div class="form-group"><label for="g3_full_name">الاسم الرباعي للإضافة</label><input type="text" id="g3_full_name"></div>
        <div class="form-group"><label for="g3_random_count">عدد الأسماء العشوائية</label><input type="number" id="g3_random_count" value="30" min="1" max="100"></div>
    </div>
    <div class="button-group">
        <button class="generate-btn" onclick="generateTable3()">🔄 توليد الجدول الثالث</button>
        <button id="g3_jpg-button" class="jpg-btn" onclick="downloadImage('g3_printable-area','g3_table_date_header','jpg')" disabled>📄 تحميل JPG</button>
        <button id="g3_pdf-button" class="pdf-btn" onclick="downloadImage('g3_printable-area','g3_table_date_header','pdf')" disabled>📄 تحميل PDF</button>
    </div>
    <div id="g3_printable-area" class="printable-area">
        <div class="report-header">
            <span id="g3_header-right"></span>
            <span id="g3_header-center"></span>
            <span id="g3_header-left">(7)</span>
        </div>
        <div id="g3_result_table" class="result-table"></div>
        <div class="report-footer">
            <div class="signature-area"><div id="g3_footer-sequence">التسلسل 107</div></div>
        </div>
    </div>
</div>

<script>
let pyodideReady = false;
let pyodide;

async function loadPyodideAndPackages() {
    console.log("بدء تحميل Pyodide...");
    pyodide = await loadPyodide();
    pyodideReady = true;
    console.log("Pyodide جاهز.");
}
loadPyodideAndPackages();

// ===================================================================
//                          وظائف الجدول الأول
// ===================================================================
async function generateTable1() {
    if (!pyodideReady) { alert("Pyodide لا يزال قيد التحميل."); return; }

    const tawn = document.getElementById("g1_tawn").value;
    const city = document.getElementById("g1_city").value;
    const dateAboveTable = document.getElementById("g1_table_date_input").value;
    const dateInsideTable = document.getElementById("g1_receive_date_table").value;
    const cname = document.getElementById("g1_cost_name").value;
    const cmother = document.getElementById("g1_cost_mother_name").value;
    const namesCount = document.getElementById("g1_random_names_count").value;

    if (!tawn || !city || !dateAboveTable || !dateInsideTable || !cname || !cmother || !namesCount) {
        alert("الجدول الأول: يرجى ملء جميع الحقول."); return;
    }

    document.getElementById("g1_header-right").innerText = dateAboveTable;
    document.getElementById("g1_header-center").innerText = "تمت الموافقة";

    // === تم تعديل دالة اسم الأم لتكون ثنائية ===
    const pyCode = `
import random, json
female_names = ["آية", "أسيل", "أمينة", "سمية", "إسراء", "إيمان", "زينب", "مريم", "ليلى", "نجلاء", "هند", "ياسمين"]
male_names = ["أحمد", "محمد", "علي", "حسن", "حسين", "عمر", "بلال", "فيصل", "فهد", "مصطفى", "مروان", "خالد"]
def gen_male_name(): return " ".join(random.sample(male_names, 3))
def gen_female_name_binary(): return random.choice(female_names) + " " + random.choice(male_names)
table = []
for _ in range(int(${namesCount})):
    table.append(["${tawn}", "${city}", gen_male_name(), gen_female_name_binary(), "${dateInsideTable}"])
table.append(["${tawn}", "${city}", "${cname}", "${cmother}", "${dateInsideTable}"])
table.sort(key=lambda row: row[2])
json.dumps(table, ensure_ascii=False)
    `;

    const result = await pyodide.runPythonAsync(pyCode);
    const tableData = JSON.parse(result);

    let html = '<table><thead><tr><th>قسم الحماية</th><th>المحافظة</th><th>الاسم</th><th>اسم الأم</th><th>تاريخ الاستلام</th></tr></thead><tbody>';
    tableData.forEach(row => {
        html += `<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td><td>${row[4]}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById("g1_result_table").innerHTML = html;
    
    document.getElementById('g1_pdf-button').disabled = false;
    document.getElementById('g1_jpg-button').disabled = false;
}

// ===================================================================
//                          وظائف الجدول الثاني
// ===================================================================
async function generateTable2() {
    if (!pyodideReady) { alert("Pyodide لا يزال قيد التحميل."); return; }

    const tawn = document.getElementById("g2_tawn").value;
    const dateAboveTable = document.getElementById("g2_table_date_input").value;
    // === قراءة الأسماء المدخلة يدويًا ===
    const fullName = document.getElementById("g2_full_name").value;
    const motherName = document.getElementById("g2_mother_name").value;

    if (!tawn || !dateAboveTable || !fullName || !motherName) {
        alert("الجدول الثاني: يرجى ملء جميع الحقول، بما في ذلك الأسماء المراد إضافتها."); return;
    }

    document.getElementById("g2_header-right").innerText = dateAboveTable;
    document.getElementById("g2_header-center").innerText = "تمت الموافقة";

    // === تم تعديل كود بايثون ليضيف الاسم المدخل يدويًا ===
    const pyCode = `
import random, json
female_names = ["آية", "أسيل", "أمينة", "سمية", "إسراء", "إيمان", "زينب", "مريم", "ليلى", "نجلاء", "هند", "ياسمين"]
male_names = ["أحمد", "محمد", "علي", "حسن", "حسين", "عمر", "بلال", "فيصل", "فهد", "مصطفى", "مروان", "خالد", "سعد", "جاسم"]
def gen_full_name(): return " ".join(random.sample(male_names, 4))
def gen_mother_name(): return random.choice(female_names) + " " + " ".join(random.sample(male_names, 2))
table = []
# إنشاء 33 اسمًا عشوائيًا
for _ in range(33):
    table.append(["${tawn}", gen_full_name(), gen_mother_name()])
# إضافة الاسم المدخل يدويًا
table.append(["${tawn}", "${fullName}", "${motherName}"])
table.sort(key=lambda row: row[1])
json.dumps(table, ensure_ascii=False)
    `;

    const result = await pyodide.runPythonAsync(pyCode);
    const tableData = JSON.parse(result);

    let html = '<table><tbody>';
    tableData.forEach(row => {
        html += `<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td></tr>`;
    });
    html += '</tbody></table>';
    document.getElementById("g2_result_table").innerHTML = html;
    
    document.getElementById('g2_pdf-button').disabled = false;
    document.getElementById('g2_jpg-button').disabled = false;
}


// ===================================================================
//                      وظيفة التحميل (مشتركة للجدولين)
// ===================================================================
function downloadImage(printableAreaId, dateInputId, format) {
    const printableArea = document.getElementById(printableAreaId);
    const dateValue = document.getElementById(dateInputId).value;
    
    const jpgButton = document.getElementById(printableAreaId.replace('printable-area', 'jpg-button'));
    const pdfButton = document.getElementById(printableAreaId.replace('printable-area', 'pdf-button'));
    jpgButton.disabled = true;
    pdfButton.disabled = true;
    
    html2canvas(printableArea, { scale: 2, useCORS: true }).then(canvas => {
        const filename = `تقرير-${dateValue || 'بدون-تاريخ'}`;
        if (format === 'jpg') {
            const image = canvas.toDataURL('image/jpeg', 0.9);
            const link = document.createElement('a');
            link.href = image;
            link.download = `${filename}.jpg`;
            link.click();
        } else {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const imgWidth = 210;
            const pageHeight = 297;
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            const doc = new jsPDF('p', 'mm', 'a4');
            let position = 0;
            doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
            while (heightLeft > 0) {
                position = heightLeft - imgHeight;
                doc.addPage();
                doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }
            doc.save(`${filename}.pdf`);
        }
    }).catch(err => {
        console.error("فشل تحويل HTML إلى صورة:", err);
        alert("عذراً، حدث خطأ أثناء إنشاء الملف.");
    }).finally(() => {
        jpgButton.disabled = false;
        pdfButton.disabled = false;
    });
}

async function generateTable3() {
    if (!pyodideReady) { alert("Pyodide لا يزال قيد التحميل."); return; }

    const tawn = document.getElementById("g3_tawn").value;
    const dateHeader = document.getElementById("g3_table_date_header").value;
    const dateInside = document.getElementById("g3_table_date_inside").value;
    const fixedNumber = document.getElementById("g3_fixed_number").value;
    const fullName = document.getElementById("g3_full_name").value;
    const randomCount = parseInt(document.getElementById("g3_random_count").value);

    if (!tawn || !dateHeader || !dateInside || !fixedNumber || !fullName || !randomCount) {
        alert("يرجى ملء جميع الحقول."); return;
    }

    document.getElementById("g3_header-right").innerText = dateHeader;
    document.getElementById("g3_header-center").innerText = "تمت الموافقة";

    // توليد الأسماء عبر Pyodide
    const pyCode = `
import random, json
female_names = ["آية","أسيل","أمينة","سمية","إسراء","إيمان","زينب","مريم","ليلى","نجلاء","هند","ياسمين"]
male_names = ["أحمد","محمد","علي","حسن","حسين","عمر","بلال","فيصل","فهد","مصطفى","مروان","خالد","سعد","جاسم"]
def gen_full_name(): return " ".join(random.sample(male_names, 4))
def gen_mother_name(): return random.choice(female_names) + " " + " ".join(random.sample(male_names,2))
table=[]
for _ in range(${randomCount}):
    table.append(["${tawn}", gen_full_name(), "${fixedNumber}", "${dateInside}"])
# إضافة الاسم اليدوي
table.append(["${tawn}", "${fullName}", "${fixedNumber}", "${dateInside}"])
# ترتيب أبجدي حسب الاسم الرباعي
table.sort(key=lambda x: x[1])
json.dumps(table, ensure_ascii=False)
    `;

    const result = await pyodide.runPythonAsync(pyCode);
    const tableData = JSON.parse(result);

    let html = '<table><tbody>';
    tableData.forEach((row, idx) => {
        html += `<tr><td>${idx+1}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td><td>${row[0]}</td></tr>`;
    });
    html += '</tbody></table>';

    document.getElementById("g3_result_table").innerHTML = html;

    document.getElementById('g3_pdf-button').disabled = false;
    document.getElementById('g3_jpg-button').disabled = false;
}

</script>
</body>
</html>
