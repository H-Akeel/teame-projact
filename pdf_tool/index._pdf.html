<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <link rel="icon" type="image/png" href="Photo/t ~.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PDF Suite | منصة الأدوات الاحترافية</title>

  <!-- Libraries -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <!-- Sortable.js for drag and drop sorting -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">

  <style>
    :root {
      --bg-color: #eef2f9;
      --card-color: #f5f8fc;
      --primary-color: #4a55ff;
      --primary-light: #6a72ff;
      --secondary-color: #a45eff;
      --text-color: #2c3e50;
      --muted-color: #8d99ae;
      --border-color: rgba(255, 255, 255, 0.5);
      --shadow-light: rgba(136, 165, 191, 0.48);
      --shadow-dark: rgba(255, 255, 255, 0.8);
      --radius: 16px;
      --transition: all 0.3s ease;
    }
    
    [data-theme="dark"] {
      --bg-color: #1b1f28;
      --card-color: #242936;
      --primary-color: #5a64ff;
      --primary-light: #7a82ff;
      --secondary-color: #b46eff;
      --text-color: #edf2f4;
      --muted-color: #a0aec0;
      --border-color: rgba(0, 0, 0, 0.2);
      --shadow-light: rgba(0, 0, 0, 0.3);
      --shadow-dark: rgba(255, 255, 255, 0.05);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; }
    body {
      font-family: 'IBM Plex Sans Arabic', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.7;
      display: flex;
      transition: var(--transition);
      overflow: hidden;
    }

    /* --- Sidebar --- */
    .sidebar {
      width: 260px;
      background-color: var(--card-color);
      padding: 30px 20px;
      height: 100vh;
      position: sticky;
      top: 0;
      display: flex;
      flex-direction: column;
      border-inline-end: 1px solid var(--border-color);
      box-shadow: 5px 0 20px rgba(0,0,0,0.02);
      transition: var(--transition);
    }
    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 40px;
      text-align: center;
    }
    .nav-menu { list-style: none; flex-grow: 1; }
    .nav-item a {
      display: flex;
      align-items: center;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: var(--radius);
      text-decoration: none;
      color: var(--muted-color);
      font-weight: 500;
      transition: var(--transition);
      cursor: pointer;
    }
    .nav-item a:hover { background-color: var(--bg-color); color: var(--primary-color); }
    .nav-item a.active {
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
      color: #fff;
      box-shadow: 0 5px 15px rgba(74, 85, 255, 0.3);
    }
    .nav-item i { font-size: 1.2rem; width: 30px; margin-inline-end: 15px; }
    .theme-switcher {
      background: var(--bg-color);
      border: none;
      padding: 12px;
      border-radius: var(--radius);
      cursor: pointer;
      color: var(--muted-color);
      font-size: 1.2rem;
      transition: var(--transition);
    }
    .theme-switcher:hover {
      color: var(--primary-color);
    }

    /* --- Main Content --- */
    .main-content {
      flex-grow: 1;
      padding: 40px;
      height: 100vh;
      overflow-y: auto;
    }
    .tool-page { 
      display: none; 
      opacity: 0;
      transform: translateY(20px);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }
    .tool-page.active { 
      display: block; 
      opacity: 1;
      transform: translateY(0);
    }
    
    .page-header { margin-bottom: 30px; }
    .page-header h1 { font-size: 2.5rem; font-weight: 700; margin-bottom: 5px; }
    .page-header p { color: var(--muted-color); font-size: 1.1rem; }

    .tool-card {
      background: var(--card-color);
      border-radius: var(--radius);
      padding: 30px;
      box-shadow: -5px -5px 10px var(--shadow-dark), 5px 5px 10px var(--shadow-light);
      border: 1px solid var(--border-color);
    }

    .input-area {
      margin-bottom: 20px;
      padding: 20px;
      border: 2px dashed var(--muted-color);
      border-radius: var(--radius);
      text-align: center;
      transition: var(--transition);
      cursor: pointer;
    }
    .input-area:hover {
      border-color: var(--primary-color);
      background-color: var(--bg-color);
    }
    .input-area.drag-over { 
      border-color: var(--primary-color); 
      background-color: var(--bg-color); 
      transform: scale(1.02);
    }
    .input-area label { 
      cursor: pointer; 
      color: var(--primary-color); 
      font-weight: 700; 
      text-decoration: underline;
    }
    .input-area input[type="file"] { display: none; }
    
    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    .option-group label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--muted-color); }
    input[type="number"], input[type="text"] {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--border-color);
      border-radius: 10px;
      background: var(--bg-color);
      color: var(--text-color);
      font-size: 1rem;
      transition: var(--transition);
    }
    input[type="number"]:focus, input[type="text"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(74, 85, 255, 0.1);
    }

    .btn {
      background: linear-gradient(90deg, var(--primary-color), var(--primary-light));
      color: #fff;
      border: none;
      border-radius: 12px;
      padding: 15px 30px;
      cursor: pointer;
      font-weight: 700;
      font-size: 1rem;
      transition: var(--transition);
      box-shadow: 0 5px 15px rgba(74, 85, 255, 0.2);
      display: inline-flex;
      align-items: center;
      gap: 10px;
    }
    .btn:hover { 
      transform: translateY(-3px); 
      box-shadow: 0 8px 20px rgba(74, 85, 255, 0.3); 
    }
    .btn.outline { 
      background: transparent; 
      color: var(--primary-color); 
      border: 2px solid var(--primary-color); 
      box-shadow: none; 
    }
    .btn.outline:hover {
      background: var(--primary-color);
      color: #fff;
    }
    .btn:disabled { 
      background: var(--muted-color); 
      box-shadow: none; 
      cursor: not-allowed; 
      opacity: 0.6; 
      transform: none;
    }

    .preview-area { margin-top: 20px; min-height: 150px; }
    .sort-instructions {
      background: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 15px;
      font-size: 0.9rem;
      color: var(--muted-color);
      text-align: center;
      display: none;
    }
    .sort-instructions.show {
      display: block;
    }
    .sort-instructions i {
      color: var(--primary-color);
      margin-inline-end: 8px;
    }
    
    .thumbs { 
      display: flex; 
      gap: 15px; 
      flex-wrap: wrap; 
      min-height: 100px;
      padding: 10px;
      border-radius: var(--radius);
      transition: var(--transition);
    }
    .thumbs.sortable-active {
      background: var(--bg-color);
      border: 2px dashed var(--primary-color);
    }
    
    .thumb {
      position: relative;
      background: var(--bg-color);
      border-radius: 12px;
      padding: 10px;
      cursor: grab;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      transition: var(--transition);
      border: 2px solid transparent;
    }
    .thumb:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(0,0,0,0.1);
      border-color: var(--primary-color);
    }
    .thumb.sortable-ghost {
      opacity: 0.4;
      transform: rotate(5deg);
    }
    .thumb.sortable-chosen {
      cursor: grabbing;
      transform: scale(1.05);
      box-shadow: 0 8px 20px rgba(74, 85, 255, 0.3);
      border-color: var(--primary-color);
    }
    .thumb canvas, .thumb img { 
      max-width: 140px; 
      height: auto; 
      border-radius: 8px; 
      pointer-events: none;
    }
    
    /* File order indicator */
    .thumb::before {
      content: attr(data-order);
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--primary-color);
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(74, 85, 255, 0.3);
    }

    .status-area { margin-top: 20px; }
    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: var(--bg-color);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
      display: none;
    }
    .progress-bar-inner { 
      width: 0%; 
      height: 100%; 
      background: linear-gradient(90deg, var(--primary-color), var(--secondary-color)); 
      transition: width 0.3s; 
    }
    .status-text { font-weight: 500; color: var(--muted-color); }
    .ok { color: #2ecc71; }
    .err { color: #e74c3c; }

    /* Toast Notifications */
    .toast-container { position: fixed; bottom: 20px; inset-inline-start: 20px; z-index: 2000; }
    .toast {
      background: #34495e;
      color: #fff;
      padding: 15px 20px;
      border-radius: 12px;
      margin-bottom: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      opacity: 0;
      transform: translateY(20px);
      animation: toast-in 0.5s forwards;
    }
    .toast.error { background: #c0392b; }
    .toast.success { background: #27ae60; }
    @keyframes toast-in { to { opacity: 1; transform: translateY(0); } }

    /* Responsive Design */
    @media (max-width: 768px) {
      body { flex-direction: column; overflow: visible; }
      .sidebar { width: 100%; height: auto; }
      .main-content { height: auto; }
      .thumbs { justify-content: center; }
    }
  </style>
</head>
<body>

  <aside class="sidebar">
    <!-- إضافة صورة لكوكو فوق الشعار -->
    <div style="display: flex; flex-direction: column; align-items: center; margin-bottom: 10px;">
      <img src="..//Photo/timepdf.png" 
           alt="g,;," 
           style="width: 90px; height: 90px; object-fit: contain; margin-bottom: 10px; border-radius: 50%; box-shadow: 0 2px 12px rgba(0,0,0,0.10);" />
    </div>
    <!-- الشعار بدون الأيقونة -->
    <div class="logo" style="margin-bottom: 40px; text-align: center;">
      PDF Suite
    </div>
    <ul class="nav-menu">
      <li class="nav-item"><a data-page="merge" class="nav-link active"><i class="fas fa-link fa-fw"></i> دمج الملفات</a></li>
      <li class="nav-item"><a data-page="img2pdf" class="nav-link"><i class="fas fa-image fa-fw"></i> صور إلى PDF</a></li>
      <li class="nav-item"><a data-page="pdf2img" class="nav-link"><i class="fas fa-file-image fa-fw"></i> PDF إلى صور</a></li>
      <li class="nav-item"><a data-page="split" class="nav-link"><i class="fas fa-cut fa-fw"></i> تقسيم ملف</a></li>
      <li class="nav-item"><a data-page="extract" class="nav-link"><i class="fas fa-file-alt fa-fw"></i> استخراج النصوص</a></li>
    </ul>
    <button class="theme-switcher" id="theme-switcher" aria-label="تبديل الوضع"><i class="fas fa-moon"></i></button>
  </aside>

  <main class="main-content">
    <!-- Page 1: Merge -->
    <section id="merge" class="tool-page active">
      <div class="page-header">
        <h1>دمج ملفات PDF</h1>
        <p>اجمع عدة ملفات PDF في ملف واحد، مع إمكانية إعادة ترتيبها بالسحب والإفلات.</p>
      </div>
      <div class="tool-card">
        <div class="input-area" id="merge-dropzone">
          <i class="fas fa-cloud-upload-alt fa-3x" style="color:var(--muted-color); margin-bottom:15px;"></i>
          <p>اسحب وأفلت الملفات هنا، أو <label for="merge-input">اختر من جهازك</label></p>
          <input type="file" id="merge-input" accept="application/pdf" multiple>
        </div>
        <div class="preview-area">
          <div class="sort-instructions" id="merge-sort-instructions">
            <i class="fas fa-arrows-alt"></i>
            اسحب الملفات لإعادة ترتيبها حسب الترتيب المطلوب في الملف النهائي
          </div>
          <div class="thumbs" id="merge-thumbs"></div>
        </div>
        <div class="status-area" id="merge-status-area">
          <div class="progress-bar"><div class="progress-bar-inner"></div></div>
          <span class="status-text"></span>
        </div>
        <div style="margin-top: 20px; display: flex; gap: 15px;">
          <button class="btn" id="merge-run" disabled><i class="fas fa-play"></i> بدء الدمج</button>
          <button class="btn outline" id="merge-clear">مسح الكل</button>
        </div>
      </div>
    </section>

    <!-- Page 2: Images to PDF -->
    <section id="img2pdf" class="tool-page">
      <div class="page-header">
        <h1>تحويل صور إلى PDF</h1>
        <p>اجمع صورك في ملف PDF واحد أنيق وسهل المشاركة.</p>
      </div>
      <div class="tool-card">
        <div class="input-area" id="img2pdf-dropzone">
          <i class="fas fa-images fa-3x" style="color:var(--muted-color); margin-bottom:15px;"></i>
          <p>اسحب وأفلت الصور هنا، أو <label for="img2pdf-input">اختر من جهازك</label></p>
          <input type="file" id="img2pdf-input" accept="image/*" multiple>
        </div>
        <div class="preview-area">
          <div class="sort-instructions" id="img2pdf-sort-instructions">
            <i class="fas fa-arrows-alt"></i>
            اسحب الصور لإعادة ترتيبها حسب الترتيب المطلوب في ملف PDF
          </div>
          <div class="thumbs" id="img2pdf-thumbs"></div>
        </div>
        <div class="status-area" id="img2pdf-status-area">
          <div class="progress-bar"><div class="progress-bar-inner"></div></div>
          <span class="status-text"></span>
        </div>
        <div style="margin-top: 20px; display: flex; gap: 15px;">
          <button class="btn" id="img2pdf-run" disabled><i class="fas fa-play"></i> بدء التحويل</button>
          <button class="btn outline" id="img2pdf-clear">مسح الكل</button>
        </div>
      </div>
    </section>
    
    <!-- Page 3: PDF to Images -->
    <section id="pdf2img" class="tool-page">
      <div class="page-header">
        <h1>PDF إلى صور</h1>
        <p>استخرج صفحات ملف PDF كصور منفصلة بجودة عالية.</p>
      </div>
      <div class="tool-card">
        <div class="input-area" id="pdf2img-dropzone">
          <i class="fas fa-file-image fa-3x" style="color:var(--muted-color); margin-bottom:15px;"></i>
          <p><label for="pdf2img-input">اختر ملف PDF</label></p>
          <input type="file" id="pdf2img-input" accept="application/pdf">
        </div>
        <div class="options-grid">
          <div class="option-group">
            <label for="pdf2img-from">من صفحة</label>
            <input type="number" id="pdf2img-from" min="1" placeholder="البداية">
          </div>
          <div class="option-group">
            <label for="pdf2img-to">إلى صفحة</label>
            <input type="number" id="pdf2img-to" min="1" placeholder="النهاية">
          </div>
        </div>
        <div class="status-area" id="pdf2img-status-area">
          <div class="progress-bar"><div class="progress-bar-inner"></div></div>
          <span class="status-text"></span>
        </div>
        <div style="margin-top: 20px;">
          <button class="btn" id="pdf2img-run" disabled><i class="fas fa-play"></i> بدء التحويل</button>
        </div>
      </div>
    </section>

    <!-- Page 4: Split PDF -->
    <section id="split" class="tool-page">
      <div class="page-header">
        <h1>تقسيم ملف PDF</h1>
        <p>استخرج نطاقًا محددًا من الصفحات كملف PDF جديد.</p>
      </div>
      <div class="tool-card">
        <div class="input-area" id="split-dropzone">
          <i class="fas fa-cut fa-3x" style="color:var(--muted-color); margin-bottom:15px;"></i>
          <p><label for="split-input">اختر ملف PDF</label></p>
          <input type="file" id="split-input" accept="application/pdf">
        </div>
        <div class="options-grid">
          <div class="option-group">
            <label for="split-from">من صفحة</label>
            <input type="number" id="split-from" min="1" placeholder="البداية">
          </div>
          <div class="option-group">
            <label for="split-to">إلى صفحة</label>
            <input type="number" id="split-to" min="1" placeholder="النهاية">
          </div>
        </div>
        <div class="status-area" id="split-status-area">
          <div class="progress-bar"><div class="progress-bar-inner"></div></div>
          <span class="status-text"></span>
        </div>
        <div style="margin-top: 20px;">
          <button class="btn" id="split-run" disabled><i class="fas fa-play"></i> بدء التقسيم</button>
        </div>
      </div>
    </section>

    <!-- Page 5: Extract Text -->
    <section id="extract" class="tool-page">
      <div class="page-header">
        <h1>استخراج النصوص (OCR)</h1>
        <p>تعرف على النصوص في ملفات PDF والصور بدعم للغة العربية.</p>
      </div>
      <div class="tool-card">
        <div class="input-area" id="extract-dropzone">
          <i class="fas fa-file-alt fa-3x" style="color:var(--muted-color); margin-bottom:15px;"></i>
          <p><label for="extract-input">اختر ملفات PDF أو صور</label></p>
          <input type="file" id="extract-input" accept="application/pdf,image/*" multiple>
        </div>
        <div class="status-area" id="extract-status-area">
          <div class="progress-bar"><div class="progress-bar-inner"></div></div>
          <span class="status-text"></span>
        </div>
        <div style="margin-top: 20px;">
          <button class="btn" id="extract-run" disabled><i class="fas fa-play"></i> بدء الاستخراج</button>
        </div>
        <textarea id="extract-output" readonly placeholder="سيظهر النص المستخرج هنا..." style="width: 100%; height: 200px; margin-top: 20px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 10px; padding: 15px; color: var(--text-color); resize: vertical;"></textarea>
        <div style="margin-top: 10px;">
          <button class="btn outline" id="extract-save"><i class="fas fa-save"></i> حفظ النص</button>
        </div>
      </div>
    </section>
  </main>
  
  <div id="toast-container" class="toast-container"></div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      console.log('PDF Suite مع خاصية الترتيب تم تحميلها بنجاح');
      
      // --- App State ---
      const appState = {
        merge: { files: [], sortable: null },
        img2pdf: { files: [], sortable: null },
        pdf2img: { file: null },
        split: { file: null },
        extract: { files: [] }
      };

      // --- Elements ---
      const navLinks = document.querySelectorAll('.nav-link');
      const pages = document.querySelectorAll('.tool-page');
      const themeSwitcher = document.getElementById('theme-switcher');
      const toastContainer = document.getElementById('toast-container');

      // --- Utility Functions ---
      const showToast = (message, type = 'info') => {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
      };

      const clampRange = (from, to, max) => {
        let s = Math.max(1, from || 1);
        let e = Math.min(max, to || max);
        if (s > e) [s, e] = [e, s];
        return [s, e];
      };

      const downloadBlob = (blob, filename) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; 
        a.download = filename; 
        a.click();
        setTimeout(() => URL.revokeObjectURL(url), 2000);
      };

      const updateStatus = (tool, text, progress = -1) => {
        const statusText = document.querySelector(`#${tool}-status-area .status-text`);
        const progressBar = document.querySelector(`#${tool}-status-area .progress-bar`);
        const progressBarInner = document.querySelector(`#${tool}-status-area .progress-bar-inner`);
        
        if (statusText) statusText.textContent = text;
        if (progressBar && progressBarInner) {
          if (progress >= 0) {
            progressBar.style.display = 'block';
            progressBarInner.style.width = `${progress}%`;
          } else {
            progressBar.style.display = 'none';
          }
        }
      };

      // Update file order indicators
      const updateFileOrder = (thumbsContainer) => {
        const thumbs = thumbsContainer.querySelectorAll('.thumb');
        thumbs.forEach((thumb, index) => {
          thumb.setAttribute('data-order', index + 1);
        });
      };

      // --- Navigation Logic ---
      const showPage = (pageId) => {
        console.log('Switching to page:', pageId);
        
        // Hide all pages
        pages.forEach(page => {
          page.classList.remove('active');
        });
        
        // Remove active class from all nav links
        navLinks.forEach(link => {
          link.classList.remove('active');
        });
        
        // Show target page
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
          targetPage.classList.add('active');
        }
        
        // Add active class to clicked nav link
        const activeLink = document.querySelector(`[data-page="${pageId}"]`);
        if (activeLink) {
          activeLink.classList.add('active');
        }
      };

      // Add click event listeners to navigation links
      navLinks.forEach(link => {
        link.addEventListener('click', (e) => {
          e.preventDefault();
          const pageId = e.currentTarget.getAttribute('data-page');
          if (pageId) {
            showPage(pageId);
          }
        });
      });

      // --- Theme Switcher Logic ---
      const currentTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', currentTheme);
      themeSwitcher.querySelector('i').className = currentTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
      
      themeSwitcher.addEventListener('click', () => {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        themeSwitcher.querySelector('i').className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        showToast(`تم التبديل إلى الوضع ${newTheme === 'dark' ? 'الليلي' : 'النهاري'}`, 'success');
      });

      // --- Drag and Drop Logic ---
      document.querySelectorAll('.input-area').forEach(zone => {
        zone.addEventListener('dragover', (e) => {
          e.preventDefault();
          zone.classList.add('drag-over');
        });
        
        zone.addEventListener('dragleave', () => {
          zone.classList.remove('drag-over');
        });
        
        zone.addEventListener('drop', (e) => {
          e.preventDefault();
          zone.classList.remove('drag-over');
          const inputId = zone.querySelector('label').getAttribute('for');
          const input = document.getElementById(inputId);
          if (input) {
            input.files = e.dataTransfer.files;
            input.dispatchEvent(new Event('change'));
          }
        });
        
        // Click to open file dialog
        zone.addEventListener('click', (e) => {
          if (e.target.tagName !== 'LABEL') {
            const inputId = zone.querySelector('label').getAttribute('for');
            const input = document.getElementById(inputId);
            if (input) input.click();
          }
        });
      });

      // --- Tool Modules ---

      // 1. Merge Module with Sorting
      (() => {
        const tool = 'merge';
        const state = appState.merge;
        const input = document.getElementById(`${tool}-input`);
        const thumbs = document.getElementById(`${tool}-thumbs`);
        const runBtn = document.getElementById(`${tool}-run`);
        const clearBtn = document.getElementById(`${tool}-clear`);
        const sortInstructions = document.getElementById(`${tool}-sort-instructions`);

        const initSortable = () => {
          if (state.sortable) {
            state.sortable.destroy();
          }
          
          state.sortable = Sortable.create(thumbs, {
            animation: 200,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onStart: () => {
              thumbs.classList.add('sortable-active');
            },
            onEnd: (evt) => {
              thumbs.classList.remove('sortable-active');
              // Update the files array to match new order
              const movedFile = state.files.splice(evt.oldIndex, 1)[0];
              state.files.splice(evt.newIndex, 0, movedFile);
              updateFileOrder(thumbs);
              showToast('تم تغيير ترتيب الملفات', 'success');
            }
          });
        };

        const renderThumbs = async () => {
          if (!thumbs) return;
          thumbs.innerHTML = '';
          updateStatus(tool, `⏳ جاري تحميل ${state.files.length} ملفات...`, 0);
          
          for (let i = 0; i < state.files.length; i++) {
            const file = state.files[i];
            try {
              const buf = await file.arrayBuffer();
              const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
              const page = await pdf.getPage(1);
              const viewport = page.getViewport({ scale: 0.3 });
              const canvas = document.createElement('canvas');
              canvas.width = viewport.width; 
              canvas.height = viewport.height;
              await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
              
              const wrap = document.createElement('div'); 
              wrap.className = 'thumb'; 
              wrap.setAttribute('data-order', i + 1);
              wrap.appendChild(canvas);
              thumbs.appendChild(wrap);
              
              updateStatus(tool, `⏳ تم تحميل ${i + 1}/${state.files.length}`, ((i + 1) / state.files.length) * 100);
            } catch (err) { 
              showToast(`فشل تحميل الملف: ${file.name}`, 'error'); 
            }
          }
          
          updateStatus(tool, `تم تحميل ${state.files.length} ملفات. يمكنك إعادة ترتيبها بالسحب والإفلات.`);
          
          // Show sort instructions and initialize sortable
          if (state.files.length > 1) {
            sortInstructions.classList.add('show');
            initSortable();
          } else {
            sortInstructions.classList.remove('show');
          }
        };

        if (input) {
          input.addEventListener('change', async (e) => {
            state.files = Array.from(e.target.files);
            if (runBtn) runBtn.disabled = state.files.length < 2;
            await renderThumbs();
          });
        }

        if (clearBtn) {
          clearBtn.addEventListener('click', () => {
            state.files = []; 
            if (thumbs) thumbs.innerHTML = ''; 
            if (input) input.value = ''; 
            if (runBtn) runBtn.disabled = true;
            if (sortInstructions) sortInstructions.classList.remove('show');
            if (state.sortable) {
              state.sortable.destroy();
              state.sortable = null;
            }
            updateStatus(tool, '');
          });
        }

        if (runBtn) {
          runBtn.addEventListener('click', async () => {
            if (state.files.length < 2) return showToast('اختر ملفين على الأقل', 'error');
            runBtn.disabled = true;
            updateStatus(tool, '🚀 بدء عملية الدمج بالترتيب المحدد...', 0);
            
            try {
              const mergedPdf = await PDFLib.PDFDocument.create();
              for (let i = 0; i < state.files.length; i++) {
                const file = state.files[i];
                const pdfBytes = await file.arrayBuffer();
                const pdfDoc = await PDFLib.PDFDocument.load(pdfBytes);
                const copiedPages = await mergedPdf.copyPages(pdfDoc, pdfDoc.getPageIndices());
                copiedPages.forEach(page => mergedPdf.addPage(page));
                updateStatus(tool, `🔄 دمج الملف ${i + 1}/${state.files.length}`, ((i + 1) / state.files.length) * 100);
              }
              const mergedPdfBytes = await mergedPdf.save();
              downloadBlob(new Blob([mergedPdfBytes], { type: 'application/pdf' }), 'merged.pdf');
              updateStatus(tool, '✅ اكتمل الدمج بنجاح بالترتيب المطلوب!');
              showToast('تم تحميل الملف المدموج بالترتيب المطلوب!', 'success');
            } catch (err) { 
              updateStatus(tool, `❌ خطأ: ${err.message}`); 
              showToast('فشلت عملية الدمج.', 'error'); 
            }
            runBtn.disabled = false;
          });
        }
      })();

      // 2. Images to PDF Module with Sorting
      (() => {
        const tool = 'img2pdf';
        const state = appState.img2pdf;
        const input = document.getElementById(`${tool}-input`);
        const thumbs = document.getElementById(`${tool}-thumbs`);
        const runBtn = document.getElementById(`${tool}-run`);
        const clearBtn = document.getElementById(`${tool}-clear`);
        const sortInstructions = document.getElementById(`${tool}-sort-instructions`);

        const initSortable = () => {
          if (state.sortable) {
            state.sortable.destroy();
          }
          
          state.sortable = Sortable.create(thumbs, {
            animation: 200,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onStart: () => {
              thumbs.classList.add('sortable-active');
            },
            onEnd: (evt) => {
              thumbs.classList.remove('sortable-active');
              // Update the files array to match new order
              const movedFile = state.files.splice(evt.oldIndex, 1)[0];
              state.files.splice(evt.newIndex, 0, movedFile);
              updateFileOrder(thumbs);
              showToast('تم تغيير ترتيب الصور', 'success');
            }
          });
        };

        const renderThumbs = () => {
          if (!thumbs) return;
          thumbs.innerHTML = '';
          state.files.forEach((file, index) => {
            const url = URL.createObjectURL(file);
            const img = document.createElement('img'); 
            img.src = url;
            const wrap = document.createElement('div'); 
            wrap.className = 'thumb';
            wrap.setAttribute('data-order', index + 1);
            wrap.appendChild(img);
            thumbs.appendChild(wrap);
          });
          updateStatus(tool, `تم تحميل ${state.files.length} صور. يمكنك إعادة ترتيبها بالسحب والإفلات.`);
          
          // Show sort instructions and initialize sortable
          if (state.files.length > 1) {
            sortInstructions.classList.add('show');
            initSortable();
          } else {
            sortInstructions.classList.remove('show');
          }
        };

        if (input) {
          input.addEventListener('change', (e) => {
            state.files = Array.from(e.target.files);
            if (runBtn) runBtn.disabled = state.files.length === 0;
            renderThumbs();
          });
        }

        if (clearBtn) {
          clearBtn.addEventListener('click', () => {
            state.files = []; 
            if (thumbs) thumbs.innerHTML = ''; 
            if (input) input.value = ''; 
            if (runBtn) runBtn.disabled = true;
            if (sortInstructions) sortInstructions.classList.remove('show');
            if (state.sortable) {
              state.sortable.destroy();
              state.sortable = null;
            }
            updateStatus(tool, '');
          });
        }

        if (runBtn) {
          runBtn.addEventListener('click', async () => {
            if (state.files.length === 0) return showToast('اختر صورة واحدة على الأقل', 'error');
            runBtn.disabled = true;
            updateStatus(tool, '🚀 بدء إنشاء PDF بالترتيب المحدد...', 0);
            
            try {
              const pdfDoc = await PDFLib.PDFDocument.create();
              for (let i = 0; i < state.files.length; i++) {
                const file = state.files[i];
                const bytes = await file.arrayBuffer();
                let img;
                if (file.type === 'image/png') img = await pdfDoc.embedPng(bytes);
                else img = await pdfDoc.embedJpg(bytes);
                const page = pdfDoc.addPage([img.width, img.height]);
                page.drawImage(img, { x: 0, y: 0, width: img.width, height: img.height });
                updateStatus(tool, `🔄 إضافة الصورة ${i + 1}/${state.files.length}`, ((i + 1) / state.files.length) * 100);
              }
              const pdfBytes = await pdfDoc.save();
              downloadBlob(new Blob([pdfBytes], { type: 'application/pdf' }), 'images.pdf');
              updateStatus(tool, '✅ اكتمل إنشاء PDF بالترتيب المطلوب!');
              showToast('تم تحميل ملف PDF بالترتيب المطلوب!', 'success');
            } catch (err) { 
              updateStatus(tool, `❌ خطأ: ${err.message}`); 
              showToast('فشل إنشاء PDF.', 'error'); 
            }
            runBtn.disabled = false;
          });
        }
      })();

      // 3. PDF to Images Module (unchanged)
      (() => {
        const tool = 'pdf2img';
        const state = appState.pdf2img;
        const input = document.getElementById(`${tool}-input`);
        const runBtn = document.getElementById(`${tool}-run`);
        const fromEl = document.getElementById(`${tool}-from`);
        const toEl = document.getElementById(`${tool}-to`);

        if (input) {
          input.addEventListener('change', (e) => {
            state.file = e.target.files[0];
            if (runBtn) runBtn.disabled = !state.file;
            if (state.file) updateStatus(tool, `تم اختيار الملف: ${state.file.name}`);
          });
        }

        if (runBtn) {
          runBtn.addEventListener('click', async () => {
            if (!state.file) return showToast('اختر ملف PDF أولاً', 'error');
            runBtn.disabled = true;
            updateStatus(tool, '🚀 بدء التحويل إلى صور...', 0);
            
            try {
              const buf = await state.file.arrayBuffer();
              const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
              const total = pdf.numPages;
              const [from, to] = clampRange(parseInt(fromEl?.value), parseInt(toEl?.value), total);
              const zip = new JSZip();

              for (let p = from; p <= to; p++) {
                const page = await pdf.getPage(p);
                const viewport = page.getViewport({ scale: 1.5 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width; 
                canvas.height = viewport.height;
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;
                const blob = await new Promise(res => canvas.toBlob(res, 'image/png'));
                zip.file(`page-${p}.png`, blob);
                updateStatus(tool, `🔄 تجهيز الصفحة ${p} من ${to}`, ((p - from + 1) / (to - from + 1)) * 100);
              }
              
              const zipBlob = await zip.generateAsync({ type: 'blob' });
              downloadBlob(zipBlob, `${state.file.name.replace(/\.pdf$/i, '')}_images.zip`);
              updateStatus(tool, '✅ اكتمل التحويل!');
              showToast('تم تحميل ملف الصور!', 'success');
            } catch (err) { 
              updateStatus(tool, `❌ خطأ: ${err.message}`); 
              showToast('فشل التحويل.', 'error'); 
            }
            runBtn.disabled = false;
          });
        }
      })();

      // 4. Split PDF Module (unchanged)
      (() => {
        const tool = 'split';
        const state = appState.split;
        const input = document.getElementById(`${tool}-input`);
        const runBtn = document.getElementById(`${tool}-run`);
        const fromEl = document.getElementById(`${tool}-from`);
        const toEl = document.getElementById(`${tool}-to`);

        if (input) {
          input.addEventListener('change', (e) => {
            state.file = e.target.files[0];
            if (runBtn) runBtn.disabled = !state.file;
            if (state.file) updateStatus(tool, `تم اختيار الملف: ${state.file.name}`);
          });
        }

        if (runBtn) {
          runBtn.addEventListener('click', async () => {
            if (!state.file) return showToast('اختر ملف PDF أولاً', 'error');
            runBtn.disabled = true;
            updateStatus(tool, '🚀 بدء التقسيم...', 0);
            
            try {
              const buf = await state.file.arrayBuffer();
              const srcDoc = await PDFLib.PDFDocument.load(buf);
              const total = srcDoc.getPageCount();
              const [from, to] = clampRange(parseInt(fromEl?.value), parseInt(toEl?.value), total);
              
              const newDoc = await PDFLib.PDFDocument.create();
              const pages = await newDoc.copyPages(srcDoc, Array.from({length: (to - from + 1)}, (_, i) => i + from - 1));
              pages.forEach(page => newDoc.addPage(page));
              
              const pdfBytes = await newDoc.save();
              downloadBlob(new Blob([pdfBytes], { type: 'application/pdf' }), `split_p${from}-p${to}_${state.file.name}`);
              updateStatus(tool, '✅ اكتمل التقسيم!');
              showToast('تم تحميل الملف المقسّم!', 'success');
            } catch (err) { 
              updateStatus(tool, `❌ خطأ: ${err.message}`); 
              showToast('فشل التقسيم.', 'error'); 
            }
            runBtn.disabled = false;
          });
        }
      })();

      // 5. Extract Text Module (unchanged)
      (() => {
        const tool = 'extract';
        const state = appState.extract;
        const input = document.getElementById(`${tool}-input`);
        const runBtn = document.getElementById(`${tool}-run`);
        const output = document.getElementById(`${tool}-output`);
        const saveBtn = document.getElementById(`${tool}-save`);

        if (input) {
          input.addEventListener('change', (e) => {
            state.files = Array.from(e.target.files);
            if (runBtn) runBtn.disabled = state.files.length === 0;
            if (state.files.length > 0) updateStatus(tool, `تم اختيار ${state.files.length} ملف(ات)`);
          });
        }

        if (runBtn) {
          runBtn.addEventListener('click', async () => {
            if (state.files.length === 0) return showToast('اختر ملفات أولاً', 'error');
            runBtn.disabled = true;
            updateStatus(tool, '🚀 بدء الاستخراج...', 0);
            
            try {
              let combinedText = '';
              for (let i = 0; i < state.files.length; i++) {
                const file = state.files[i];
                combinedText += `--- [ ${file.name} ] ---\n`;
                
                if (file.type === 'application/pdf') {
                  updateStatus(tool, `⏳ استخراج نص من PDF (${i+1}/${state.files.length})...`, (i / state.files.length) * 100);
                  const buf = await file.arrayBuffer();
                  const pdf = await pdfjsLib.getDocument({data: buf}).promise;
                  for(let p = 1; p <= pdf.numPages; p++){
                    const page = await pdf.getPage(p);
                    const tc = await page.getTextContent();
                    combinedText += tc.items.map(item => item.str).join(' ') + '\n';
                  }
                } else {
                  updateStatus(tool, `⏳ التعرف على الصور (${i+1}/${state.files.length})...`, (i / state.files.length) * 100);
                  const { data: { text } } = await Tesseract.recognize(file, 'ara+eng', {
                    logger: m => { 
                      updateStatus(tool, `🔄 ${m.status} ${Math.round((m.progress||0)*100)}%`); 
                    }
                  });
                  combinedText += text;
                }
                combinedText += '\n\n';
              }
              
              if (output) output.value = combinedText.trim();
              updateStatus(tool, '✅ تم استخراج النص بنجاح!');
              showToast('تم استخراج النص بنجاح!', 'success');
            } catch (err) { 
              updateStatus(tool, `❌ خطأ: ${err.message}`); 
              showToast('فشل استخراج النص.', 'error'); 
            }
            runBtn.disabled = false;
          });
        }

        if (saveBtn && output) {
          saveBtn.addEventListener('click', () => {
            const text = output.value || '';
            if (!text.trim()) return showToast('لا يوجد نص لحفظه.', 'error');
            downloadBlob(new Blob([text], {type: 'text/plain;charset=utf-8'}), 'extracted-text.txt');
            showToast('تم حفظ النص!', 'success');
          });
        }
      })();

      // Initialize with merge page
      showPage('merge');
      showToast('مرحباً بك في PDF Suite مع خاصية الترتيب المتقدمة!', 'success');
    });
  </script>
</body>
</html>





