<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>أدوات PDF المتقدمة</title>

  <!-- Libraries -->
  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.min.js"></script>
  <script>pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.9.179/pdf.worker.min.js";</script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg-light: #f7f9fc;
      --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100% );
      --card-bg: #ffffff;
      --primary: #4a90e2;
      --primary-dark: #357abd;
      --secondary: #50e3c2;
      --text-dark: #333d49;
      --text-light: #8a94a6;
      --border-color: #e4e7eb;
      --shadow: 0 10px 25px rgba(0, 0, 0, 0.07);
      --radius: 12px;
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; }
    body {
      font-family: 'Tajawal', sans-serif;
      background: var(--bg-light);
      color: var(--text-dark);
      line-height: 1.6;
    }
    header {
      background: var(--card-bg);
      padding: 20px 0;
      text-align: center;
      border-bottom: 1px solid var(--border-color);
    }
    header h1 {
      margin: 0;
      font-size: 2.2rem;
      font-weight: 700;
      color: var(--primary-dark);
    }
    header .logo-icon {
      font-size: 2.5rem;
      vertical-align: middle;
      margin-inline-end: 10px;
    }
    main {
      max-width: 1200px;
      margin: 40px auto;
      padding: 0 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 30px;
    }
    .tool {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 25px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      border: 1px solid var(--border-color);
    }
    .tool:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.1);
    }
    .tool-header {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
    }
    .tool-icon {
      font-size: 1.8rem;
      color: var(--primary);
      margin-inline-end: 15px;
      background: #eaf2fd;
      width: 50px;
      height: 50px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    .tool h2 {
      margin: 0;
      font-size: 1.4rem;
      color: var(--text-dark);
    }
    .tool .sub {
      margin: 0 0 20px;
      color: var(--text-light);
      font-size: 0.9rem;
    }
    .input-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      margin-bottom: 15px;
    }
    input[type="file"], input[type="number"], input[type="text"] {
      padding: 12px 15px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      background: #fcfdff;
      font-size: 0.9rem;
      flex-grow: 1;
      outline: none;
      transition: box-shadow 0.2s, border-color 0.2s;
    }
    input:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
    }
    .btn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 20px;
      cursor: pointer;
      font-weight: 700;
      font-size: 0.9rem;
      transition: background-color 0.2s, transform 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }
    .btn.outline {
      background: transparent;
      color: var(--primary);
      border: 1px solid var(--primary);
    }
    .preview {
      margin-top: 15px;
      border: 2px dashed var(--border-color);
      border-radius: var(--radius);
      padding: 15px;
      background: var(--bg-light);
      min-height: 100px;
      transition: border-color 0.2s;
    }
    .preview.drag-over {
      border-color: var(--primary);
      background: #eaf2fd;
    }
    .thumbs { display: flex; gap: 12px; flex-wrap: wrap; }
    .thumb {
      position: relative;
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 8px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      user-select: none;
      cursor: grab;
    }
    .thumb canvas, .thumb img {
      display: block;
      max-width: 120px;
      height: auto;
      border-radius: 4px;
    }
    .status { margin-top: 10px; font-size: 0.85rem; font-weight: 500; }
    .ok { color: #28a745; }
    .err { color: #dc3545; }
    .downloads a {
      display: inline-block;
      margin-top: 10px;
      text-decoration: none;
      font-weight: 700;
      color: var(--primary-dark);
    }
    footer {
      text-align: center;
      padding: 30px 20px;
      margin-top: 40px;
      background: var(--text-dark);
      color: #e4e7eb;
    }
    footer p { margin: 5px 0; font-size: 0.9rem; }
  </style>
</head>
<body>
  <header>
    <h1><span class="logo-icon">⚙️</span>أدوات PDF المتقدمة</h1>
  </header>

  <main>
    <!-- 1) دمج ملفات PDF -->
    <section class="tool" id="tool-merge">
      <div class="tool-header">
        <span class="tool-icon">🔗</span>
        <h2>دمج ملفات PDF</h2>
      </div>
      <p class="sub">ارفع ملفات متعددة، ثم أعد ترتيبها بالسحب والإفلات قبل الدمج.</p>
      <div class="input-group">
        <input type="file" id="merge-input" accept="application/pdf" multiple />
        <button class="btn outline" id="merge-clear">مسح</button>
      </div>
      <div class="preview" id="merge-preview">
        <div class="thumbs" id="merge-thumbs"></div>
      </div>
      <div class="input-group" style="margin-top:15px">
        <button class="btn" id="merge-run">🚀 دمج الآن</button>
        <div class="status" id="merge-status"></div>
      </div>
      <div class="downloads" id="merge-dl"></div>
    </section>

    <!-- 2) تحويل صور ➜ PDF -->
    <section class="tool" id="tool-img2pdf">
      <div class="tool-header">
        <span class="tool-icon">🖼️</span>
        <h2>تحويل صور إلى PDF</h2>
      </div>
      <p class="sub">ارفع صور (PNG/JPG)، وأعد ترتيبها بالسحب قبل التحويل.</p>
      <div class="input-group">
        <input type="file" id="img-input" accept="image/*" multiple />
        <button class="btn outline" id="img-clear">مسح</button>
      </div>
      <div class="preview" id="img-preview">
        <div class="thumbs" id="img-thumbs"></div>
      </div>
      <div class="input-group" style="margin-top:15px">
        <button class="btn" id="img2pdf-run">🚀 تحويل الآن</button>
        <div class="status" id="img-status"></div>
      </div>
      <div class="downloads" id="img-dl"></div>
    </section>

    <!-- 3) تحويل PDF ➜ صور -->
    <section class="tool" id="tool-pdf2img">
      <div class="tool-header">
        <span class="tool-icon">📄</span>
        <h2>تحويل PDF إلى صور</h2>
      </div>
      <p class="sub">حدد نطاق الصفحات (اتركه فارغًا للكل) وسيتم تصديرها كملف ZIP.</p>
      <div class="input-group">
        <input type="file" id="pdf2img-input" accept="application/pdf" />
      </div>
      <div class="input-group">
        <span>من:</span> <input type="number" id="pdf2img-from" min="1" style="width:80px">
        <span>إلى:</span> <input type="number" id="pdf2img-to" min="1" style="width:80px">
      </div>
      <div class="input-group" style="margin-top:15px">
        <button class="btn" id="pdf2img-run">🚀 تحويل الآن</button>
        <div class="status" id="pdf2img-status"></div>
      </div>
      <div class="downloads" id="pdf2img-dl"></div>
    </section>

    <!-- 4) تقسيم PDF -->
    <section class="tool" id="tool-split">
      <div class="tool-header">
        <span class="tool-icon">✂️</span>
        <h2>تقسيم ملف PDF</h2>
      </div>
      <p class="sub">حدد من أي صفحة إلى أي صفحة لإنشاء ملف جديد.</p>
      <div class="input-group">
        <input type="file" id="split-input" accept="application/pdf" />
      </div>
      <div class="input-group">
        <span>من:</span> <input type="number" id="split-from" min="1" style="width:80px">
        <span>إلى:</span> <input type="number" id="split-to" min="1" style="width:80px">
      </div>
      <div class="input-group" style="margin-top:15px">
        <button class="btn" id="split-run">🚀 تقسيم الآن</button>
        <div class="status" id="split-status"></div>
      </div>
      <div class="downloads" id="split-dl"></div>
    </section>

    <!-- 5) استخراج النصوص -->
    <section class="tool" id="tool-extract">
      <div class="tool-header">
        <span class="tool-icon">📝</span>
        <h2>استخراج النصوص (OCR)</h2>
      </div>
      <p class="sub">من PDF أو صور. يدعم العربية والإنجليزية.</p>
      <div class="input-group">
        <input type="file" id="extract-input" accept="application/pdf,image/*" multiple />
      </div>
      <div class="input-group" style="margin-top:15px">
        <button class="btn" id="extract-run">🚀 استخراج الآن</button>
        <div class="status" id="extract-status"></div>
      </div>
      <div class="preview" style="max-height:200px;overflow:auto;margin-top:15px">
        <pre id="extract-output" style="white-space:pre-wrap;word-wrap:break-word;margin:0;font-size:0.8rem"></pre>
      </div>
      <div class="input-group" style="margin-top:15px">
        <button class="btn outline" id="extract-save">حفظ كنص TXT</button>
      </div>
    </section>
  </main>

  <footer>
    <p>تم التطوير بواسطة: حسين عقيل صبري 👨‍💻</p>
    <p style="color: var(--text-light)">جميع العمليات تتم في متصفحك مباشرة لضمان خصوصية ملفاتك.</p>
  </footer>

  <script>
    // The JavaScript logic remains largely the same, but with updated IDs and a few tweaks for the new UI.
    // I've consolidated the text extraction tool and added drag-over visual feedback.

    /* ============ حالة/ذاكرة محلية ============ */
    let mergeFiles = []; // [{file, thumbCanvas}]
    let imgFiles   = []; // [{file, imgEl}]

    /* ============ أدوات مساعدة عامة ============ */
    const byId = (id)=>document.getElementById(id);
    function downloadBlob(blob, filename){
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(url),2000);
    }
    const clampRange = (from, to, max)=>{
      let s = Math.max(1, from||1);
      let e = Math.min(max, to||max);
      if (s>e) [s,e]=[e,s];
      return [s,e];
    };

    /* ============ عرض مصغرات PDF (صفحة أولى) ============ */
    async function renderPdfFirstPageThumb(file, scale=0.28){
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data:buf}).promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({ scale });
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = viewport.width; canvas.height = viewport.height;
      await page.render({canvasContext:ctx, viewport}).promise;
      return canvas;
    }

    /* ============ سحب وإفلات عام للمصفوفات ============ */
    function enableDragSort(container, items, onReorder){
      container.querySelectorAll('.thumb').forEach((el, idx)=>{
        el.draggable = true;
        el.addEventListener('dragstart', e=>{
          e.dataTransfer.setData('text/plain', idx.toString());
        });
        el.addEventListener('drop', e=>{
          e.preventDefault();
          const from = parseInt(e.dataTransfer.getData('text/plain'));
          const to = idx;
          if (from===to) return;
          const [moved] = items.splice(from,1);
          items.splice(to,0,moved);
          onReorder();
        });
      });
      // Add drag-over class to the main preview area for visual feedback
      const previewArea = container.parentElement;
      previewArea.addEventListener('dragover', e => {
        e.preventDefault();
        previewArea.classList.add('drag-over');
      });
      previewArea.addEventListener('dragleave', () => previewArea.classList.remove('drag-over'));
      previewArea.addEventListener('drop', () => previewArea.classList.remove('drag-over'));
    }

    /* ============ 1) الدمج ============ */
    byId('merge-input').addEventListener('change', async (e)=>{
      mergeFiles = [];
      const container = byId('merge-thumbs'); container.innerHTML='';
      const files = Array.from(e.target.files);
      for (const f of files){
        const thumb = await renderPdfFirstPageThumb(f);
        const wrap = document.createElement('div'); wrap.className='thumb';
        wrap.appendChild(thumb); container.appendChild(wrap);
        mergeFiles.push({file:f, el:wrap});
      }
      const reorderDOM = () => {
        container.innerHTML='';
        mergeFiles.forEach(m=>container.appendChild(m.el));
        enableDragSort(container, mergeFiles, reorderDOM);
      };
      reorderDOM();
      byId('merge-status').textContent = mergeFiles.length ? `تم تحميل ${mergeFiles.length} ملف(ات).` : '';
      byId('merge-dl').innerHTML='';
    });

    byId('merge-clear').addEventListener('click', ()=>{
      mergeFiles=[]; byId('merge-thumbs').innerHTML=''; byId('merge-input').value='';
      byId('merge-status').textContent=''; byId('merge-dl').innerHTML='';
    });

    byId('merge-run').addEventListener('click', async ()=>{
      const status = byId('merge-status');
      if (!mergeFiles.length){ alert('اختر ملفين أو أكثر'); return; }
      status.textContent='⏳ جارٍ الدمج...';
      try{
        const out = await PDFLib.PDFDocument.create();
        for (const {file} of mergeFiles){
          const buf = await file.arrayBuffer();
          const doc = await PDFLib.PDFDocument.load(buf);
          const pages = await out.copyPages(doc, doc.getPageIndices());
          pages.forEach(p=>out.addPage(p));
        }
        const bytes = await out.save();
        const blob = new Blob([bytes], {type:'application/pdf'});
        byId('merge-dl').innerHTML='';
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download='merged.pdf'; a.textContent='📥 تحميل الملف المدموج';
        byId('merge-dl').appendChild(a);
        status.innerHTML = '<span class="ok">✅ تم الدمج بنجاح</span>';
      }catch(err){
        status.innerHTML = `<span class="err">❌ خطأ: ${err.message}</span>`;
      }
    });

    /* ============ 2) صور ➜ PDF ============ */
    byId('img-input').addEventListener('change', (e)=>{
      imgFiles = [];
      const container = byId('img-thumbs'); container.innerHTML='';
      const files = Array.from(e.target.files);
      for (const f of files){
        const url = URL.createObjectURL(f);
        const img = document.createElement('img'); img.src=url;
        const wrap = document.createElement('div'); wrap.className='thumb';
        wrap.appendChild(img); container.appendChild(wrap);
        imgFiles.push({file:f, el:wrap, url});
      }
      const reorderDOM = () => {
        container.innerHTML='';
        imgFiles.forEach(m=>container.appendChild(m.el));
        enableDragSort(container, imgFiles, reorderDOM);
      };
      reorderDOM();
      byId('img-status').textContent = imgFiles.length ? `تم تحميل ${imgFiles.length} صورة.` : '';
      byId('img-dl').innerHTML='';
    });

    byId('img-clear').addEventListener('click', ()=>{
      imgFiles.forEach(m=>URL.revokeObjectURL(m.url));
      imgFiles=[]; byId('img-thumbs').innerHTML=''; byId('img-input').value='';
      byId('img-status').textContent=''; byId('img-dl').innerHTML='';
    });

    byId('img2pdf-run').addEventListener('click', async ()=>{
      const status = byId('img-status');
      if (!imgFiles.length){ alert('اختر صورًا'); return; }
      status.textContent='⏳ جارٍ إنشاء PDF...';
      try{
        const doc = await PDFLib.PDFDocument.create();
        for (const {file} of imgFiles){
          const bytes = await file.arrayBuffer();
          let img;
          if (file.type==='image/png') img = await doc.embedPng(bytes);
          else img = await doc.embedJpg(bytes);
          const page = doc.addPage([img.width, img.height]);
          page.drawImage(img, {x:0,y:0,width:img.width,height:img.height});
        }
        const pdfBytes = await doc.save();
        const blob = new Blob([pdfBytes], {type:'application/pdf'});
        byId('img-dl').innerHTML='';
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download='images.pdf'; a.textContent='📥 تحميل ملف PDF';
        byId('img-dl').appendChild(a);
        status.innerHTML = '<span class="ok">✅ جاهز للتحميل</span>';
      }catch(err){
        status.innerHTML = `<span class="err">❌ خطأ: ${err.message}</span>`;
      }
    });

    /* ============ 3) PDF ➜ صور (PNG) ============ */
    byId('pdf2img-run').addEventListener('click', async ()=>{
      const input = byId('pdf2img-input'); const status = byId('pdf2img-status');
      const outBox = byId('pdf2img-dl'); outBox.innerHTML='';
      if (!input.files.length){ alert('اختر ملف PDF'); return; }
      status.textContent='⏳ جارٍ التحويل إلى صور...';

      try{
        const f = input.files[0];
        const buf = await f.arrayBuffer();
        const pdf = await pdfjsLib.getDocument({data:buf}).promise;
        const total = pdf.numPages;
        const [from,to] = clampRange(parseInt(byId('pdf2img-from').value), parseInt(byId('pdf2img-to').value), total);
        const zip = new JSZip();

        for (let p=from; p<=to; p++){
          const page = await pdf.getPage(p);
          const viewport = page.getViewport({scale:1.5});
          const c = document.createElement('canvas'); const ctx = c.getContext('2d');
          c.width=viewport.width; c.height=viewport.height;
          await page.render({canvasContext:ctx,viewport}).promise;
          const blob = await new Promise(res=>c.toBlob(res,'image/png'));
          zip.file(`page-${p}.png`, blob);
          status.textContent=`🔄 تم تجهيز الصفحة ${p} من ${to}`;
        }
        const zipBlob = await zip.generateAsync({type:'blob'});
        const a = document.createElement('a');
        a.href=URL.createObjectURL(zipBlob);
        a.download=`${f.name.replace(/\.pdf$/i,'')}_images.zip`;
        a.textContent='📦 تحميل كل الصور (ملف ZIP)';
        outBox.appendChild(a);
        status.innerHTML='<span class="ok">✅ اكتمل التحويل</span>';
      }catch(err){
        status.innerHTML=`<span class="err">❌ خطأ: ${err.message}</span>`;
      }
    });

    /* ============ 4) تقسيم PDF ============ */
    byId('split-run').addEventListener('click', async ()=>{
      const input = byId('split-input'); const status = byId('split-status');
      const outBox = byId('split-dl'); outBox.innerHTML='';
      if (!input.files.length){ alert('اختر ملف PDF'); return; }
      status.textContent='⏳ جارٍ التقسيم...';
      try{
        const f = input.files[0];
        const buf = await f.arrayBuffer();
        const src = await PDFLib.PDFDocument.load(buf);
        const total = src.getPageCount();
        const [from,to] = clampRange(parseInt(byId('split-from').value), parseInt(byId('split-to').value), total);
        const out = await PDFLib.PDFDocument.create();
        const pages = await out.copyPages(src, Array.from({length:(to-from+1)},(_,i)=>i+from-1));
        pages.forEach(p=>out.addPage(p));
        const bytes = await out.save();
        const blob = new Blob([bytes], {type:'application/pdf'});
        const a = document.createElement('a');
        a.href=URL.createObjectURL(blob);
        a.download=`split_p${from}-p${to}_${f.name}`;
        a.textContent='📥 تحميل الملف المقسّم';
        outBox.appendChild(a);
        status.innerHTML='<span class="ok">✅ تم التقسيم بنجاح</span>';
      }catch(err){
        status.innerHTML=`<span class="err">❌ خطأ: ${err.message}</span>`;
      }
    });

    /* ============ 5) استخراج النصوص (موحد) ============ */
    byId('extract-run').addEventListener('click', async ()=>{
      const input = byId('extract-input'); const status=byId('extract-status'); const out=byId('extract-output');
      if(!input.files.length){ alert('اختر ملف PDF أو صور'); return; }
      out.textContent=''; status.textContent='⏳ قيد التجهيز...';
      try{
        let combinedText = '';
        const files = Array.from(input.files);
        for (let i=0; i<files.length; i++){
          const f = files[i];
          combinedText += `--- [ ${f.name} ] ---\n`;
          if (f.type === 'application/pdf'){
            status.textContent = `⏳ استخراج نص من PDF (${i+1}/${files.length})...`;
            const buf = await f.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({data:buf}).promise;
            for(let p=1; p<=pdf.numPages; p++){
              const page = await pdf.getPage(p);
              const tc = await page.getTextContent();
              combinedText += tc.items.map(item=>item.str).join(' ') + '\n';
            }
          } else { // OCR for images
            status.textContent = `⏳ التعرف على الصور (${i+1}/${files.length})...`;
            const { data: { text } } = await Tesseract.recognize(f, 'ara+eng', {
              logger: m => { status.textContent = `🔄 ${m.status} ${Math.round((m.progress||0)*100)}%`; }
            });
            combinedText += text;
          }
          combinedText += '\n\n';
        }
        out.textContent = combinedText.trim();
        status.innerHTML = '<span class="ok">✅ تم استخراج النص بنجاح</span>';
      }catch(err){
        status.innerHTML=`<span class="err">❌ خطأ: ${err.message}</span>`;
      }
    });

    byId('extract-save').addEventListener('click', ()=>{
      const text = byId('extract-output').textContent || '';
      if (!text.trim()){ alert('لا يوجد نص محفوظ بعد.'); return; }
      downloadBlob(new Blob([text],{type:'text/plain;charset=utf-8'}),'extracted-text.txt');
    });
  </script>
</body>
</html>
